#################################################
# NOTES: This script is run as an array job and requires a support file called "namelist" containing specimen names to run.
#################################################


#!/bin/bash -l
#SBATCH --job-name=merge
#SBATCH --output=array_job_out_%A_%a.txt
#SBATCH --error=array_job_err_%A_%a.txt
#SBATCH --account=project_2006079
#SBATCH --partition=small
#SBATCH --time=72:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem-per-cpu=22G
#SBATCH --array=1-33

#set the input file to process
name=$(sed -n ${SLURM_ARRAY_TASK_ID}p namelist3)

module load bwa
module load biokit

#filter out cockatoo reads
/projappl/project_2006079/miniconda3/envs/fastq_screen/bin/fastq_screen --threads 8 --tag --filter 300000 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/macrogen/2210KNO-0042/RawFASTQ/${name}/${name}_1.fastq.gz /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/macrogen/2210KNO-0042/RawFASTQ/${name}/${name}_2.fastq.gz -outdir /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit

rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged.fastq.gz
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged.fastq.gz

#fix the mate pair issue with bbtools repair.sh
module load bbtools/38.96
repair.sh in1=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter.fastq.gz in2=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter.fastq.gz out1=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq out2=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq

rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter.fastq.gz
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter.fastq.gz

#unzip
gunzip -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq.gz
gunzip -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq.gz

#repair sequence names
sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq
sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:200000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq
sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:300000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq

sed -i 's/#FQST:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq
sed -i 's/#FQST:200000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq
sed -i 's/#FQST:300000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq

sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq
sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:200000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq
sed -i 's/#FQST:CitronCrested_WhlGeno:adapters:bacteria:mold:mollusks:Covid:300000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq

sed -i 's/#FQST:100000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq
sed -i 's/#FQST:200000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq
sed -i 's/#FQST:300000//g' /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq

#zip outputs
gzip /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq
gzip /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq

#Adapter removal
/projappl/project_2006079/adapterremoval/bin/AdapterRemoval --threads 8 --file1 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_1.tagged_filter_fixed1.fastq.gz --file2 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step2_FastQScreen_WGcit/${name}_2.tagged_filter_fixed2.fastq.gz --adapter1 AGATCGGAAGAGCACACGTCTGAACTCCAGTCA --adapter2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT --basename /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_WGcit/${name} --collapse --trimns --trimqualities --gzip

#Alignment
bwa mem -t8 -M  /scratch/project_2006079/salvaged/genomes/bCacCit1_TH141024/bCacCit1.curated_101424.masked.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_WGcit/${name}.pair1.truncated.gz /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_WGcit/${name}.pair2.truncated.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_WGcit/${name}_PE.bam
bwa mem -t8 -M  /scratch/project_2006079/salvaged/genomes/bCacCit1_TH141024/bCacCit1.curated_101424.masked.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_WGcit/${name}.collapsed.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_WGcit/${name}_ME.bam
bwa mem -t8 -M  /scratch/project_2006079/salvaged/genomes/bCacCit1_TH141024/bCacCit1.curated_101424.masked.fasta /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step3_AdaptorRemoval_WGcit/${name}.collapsed.truncated.gz | samtools view -F4 -hb -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_WGcit/${name}_MET.bam
