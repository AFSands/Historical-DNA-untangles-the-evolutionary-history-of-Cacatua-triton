#################################################
# NOTES: This script is run as an array script. It requires a support file "namelistaBGI" which contains a list of specimen names.
#################################################


#!/bin/bash -l
#SBATCH --job-name=merge
#SBATCH --output=array_job_out_%A_%a.txt
#SBATCH --error=array_job_err_%A_%a.txt
#SBATCH --account=project_2006079
#SBATCH --partition=small
#SBATCH --time=24:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --mem-per-cpu=64G
#SBATCH --array=1-21

#set the input file to process
name=$(sed -n ${SLURM_ARRAY_TASK_ID}p namelistaBGI)

module load mapdamage2/2.2.2
module load biopythontools
module load r-env/421
module load biokit

# Merging, sorting, marking duplicates, adding read groups, etc.
#samtools merge -@ 2 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_WGcit/${name}_PE.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step4_preliminary_bams_WGcit/${name}_ME.bam

#samtools sort -m 64G -@ 2 -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged.bam

#samtools index /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort.bam

#java -Xmx128g -jar $PICARD AddOrReplaceReadGroups I=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort.bam O=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG.bam SM=${name} LB=KAPA PL=DNBseq PU=DNBseq CN=BGI VALIDATION_STRINGENCY=SILENT

#samtools sort -m 64G -@ 2 -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG.bam

#samtools index /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.bam

#java -Xmx128g -jar $PICARD MarkDuplicates I=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.bam O=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup.bam AS=TRUE M=/scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.metrics REMOVE_DUPLICATES=FALSE VALIDATION_STRINGENCY=LENIENT

#samtools sort -m 64G -@ 2 -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup.bam

#samtools index /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam

#samtools flagstat /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam.flagstat

#samtools depth /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam | awk '{sum+=$3; sumsq+=$3*$3} END { print "Average = ",sum/NR; print "Stdev = ",sqrt(sumsq/NR - (sum/NR)**2)}' > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/coverage_${name}.txt


# Change permissions
#chmod -R 777 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_*


# MapDamage
mapDamage -i /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.bam -r /scratch/project_2006079/salvaged/genomes/bCacCit1_TH141024/bCacCit1.curated_101424.masked.fasta -d /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name} --rescale

samtools sort -m 64G -@ 2 -o /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.rescaled.bam

samtools index /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam

samtools flagstat /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam.flagstat

samtools depth /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_sort_rescaled_finalsort.bam | awk '{sum+=$3; sumsq+=$3*$3} END { print "Average = ",sum/NR; print "Stdev = ",sqrt(sumsq/NR - (sum/NR)**2)}' > /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/coverage_${name}.txt

# Change permissions
chmod -R 777 /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}
chmod -R 777 *

#removing intermediate files
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step6_MapDamage_WGcit/${name}/${name}_PEMEmerged_sort_RG_resort_Mkdup_finalsort.rescaled.bam
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged.bam
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort.bam
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort.bam.bai
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG.bam
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.bam
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort.bam.bai
rm /scratch/project_2006079/aDNA_AFS/project_2006079/aDNA/step5_MergeBams_WGcit/${name}_PEMEmerged_sort_RG_resort_Mkdup.bam
